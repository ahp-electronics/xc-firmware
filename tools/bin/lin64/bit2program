#!/bin/bash
echo '
! Device: LFE5U-45F: W25Q128JV  SPI Flash Erase,Program,Verify /home/plato/dev/github/ahp/xc-correlators/xc-firmware/build/xc8/fpga_firmware_xc8.bit
! LATTICE_NOTE "Device" "W25Q128JV"
! SVF Revision D Format
STATE RESET ;
HDR	0 ;
HIR	0 ;
TDR	0 ;
TIR	0 ;
ENDDR IDLE ;
ENDIR IDLE ;
FREQUENCY
STATE	IDLE ;
// Initializing...
ENDDR DRPAUSE ;
ENDIR IRPAUSE ;
SIR 8	TDI(FF) ;
RUNTEST IDLE	32 TCK	2.00E-002 SEC ;
SIR 8 TDI(3A) ;
SDR 16 TDI(68FE) ;
RUNTEST IDLE	32 TCK	2.00E-002 SEC ;
// IDCode Checking...
SDR 40 TDI(00000000D5)
		TDO(E8FFFFFFFF)
		MASK(FF00000000) ;
// Enabling...
SDR 8 TDI(60) ;
// Erasing...
SDR 8 TDI(60) ;
// Address 00000000h
SDR 32 TDI(0000001B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 00010000h
SDR 32 TDI(0000801B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 00020000h
SDR 32 TDI(0000401B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 00030000h
SDR 32 TDI(0000C01B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 00040000h
SDR 32 TDI(0000201B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 00050000h
SDR 32 TDI(0000A01B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 00060000h
SDR 32 TDI(0000601B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 00070000h
SDR 32 TDI(0000E01B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 00080000h
SDR 32 TDI(0000101B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 00090000h
SDR 32 TDI(0000901B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 000A0000h
SDR 32 TDI(0000501B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 000B0000h
SDR 32 TDI(0000D01B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 000C0000h
SDR 32 TDI(0000301B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 000D0000h
SDR 32 TDI(0000B01B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 000E0000h
SDR 32 TDI(0000701B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
SDR 8 TDI(60) ;
// Address 000F0000h
SDR 32 TDI(0000F01B) ;
RUNTEST DRPAUSE 2.50E+00 SEC ;
SDR 16 TDI(00A0)
		TDO(00FF)
		MASK(C100) ;
// Disabling...
SDR 8 TDI(20) ;
// Enabling...
SDR 8 TDI(60) ;
// Programming...
' | sed -e "s/FREQUENCY/FREQUENCY\t$((${2}/1000000)).00e+06 HZ ;/g"

binsize=$(( $(wc -c $1 | cut -d ' ' -f 1) * 8 ))
data=$(bit2svf -p tools/data/ $1 - DATA | tr -d ' ')

for (( addr = 0; ${addr} < ${binsize}; addr=${addr}+520 )); do
    echo 'SDR 8 TDI(60) ;'
    echo 'SDR 2080 TDI('$(echo ${data} | tail -c+${addr} | head -c 520)');'
    echo 'RUNTEST DRPAUSE 1.00E-01 SEC ;'
    echo 'SDR 16 TDI(00A0) TDO(00FF) MASK(C100) ;'
    echo 'SDR 8 TDI(60) ;'
done
echo '// Verifying...'
bit2svf -p tools/data/ $1 - VERIFY
